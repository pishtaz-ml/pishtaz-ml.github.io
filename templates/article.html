{% extends "base.html" %}

{% block title %}{{ title }} - پیشتاز{% endblock %}

{% block meta_description %}{{ summary or subtitle or "پیشتاز - پلتفرم تحلیل و بررسی سوسیالیستی معاصر" }}{% endblock %}
{% block og_image %}{{ cover or (base_url + "/home.JPG") }}{% endblock %}

{% block body_background %}
<style>
    html {
        scroll-behavior: smooth;
    }
    body {
        background-image: none !important;
    }
    
    /* TOC Styling */
    .toc-list ul {
        list-style-type: none;
        padding-right: 1.25rem;
        border-right: 1px solid #e5e7eb;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .toc-list > ul {
        padding-right: 0;
        border-right: none;
    }
    .toc-list li {
        margin-top: 0.25rem;
        margin-bottom: 0.25rem;
    }
    .toc-list a {
        text-decoration: none;
        color: #4b5563;
        display: block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        font-size: 0.925rem;
    }
    .toc-list a:hover {
        background-color: #fee2e2;
        color: #dc2626;
    }
    .toc-list a.active {
        color: #dc2626;
        font-weight: 600;
        background-color: #fee2e2;
    }

    /* Figure & Caption Styling */
    .article-figure, figure {
        margin: 2rem auto;
        display: table; /* Shrink-wrap to image width if possible, or use block */
        max-width: 100%;
        text-align: center;
    }
    .article-figure img, figure img {
        margin-left: auto;
        margin-right: auto;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .article-caption, figcaption {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #4b5563;
        font-style: italic;
        padding: 0 1rem;
        border-right: 3px solid #e5e7eb;
        display: inline-block;
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-8">
    <!-- Main Article Column (Right side on RTL) -->
    <div class="flex-grow lg:w-3/4">
            <div class="bg-paper shadow-lg rounded-lg overflow-hidden">
                <div class="px-8 py-8">
                    <div class="mb-6 border-b border-gray-200 pb-6">
                        <div class="flex items-center space-x-2 space-x-reverse text-sm text-gray-500 mb-3">
                            <a href="{{ path_for('category_page', category=category) }}" class="text-primary hover:text-secondary font-medium">
                                {{ category }}
                            </a>
                            <span>&bull;</span>
                            <span>{{ date }}</span>
                            <span>&bull;</span>
                            <span>به قلم: {{ author }}</span>
                        </div>
                        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight">
                            {{ title }}
                        </h1>
                        {% if subtitle %}
                        <h2 class="text-xl sm:text-2xl text-gray-600 mt-2 font-medium">
                            {{ subtitle }}
                        </h2>
                        {% endif %}
                    </div>
                    
                    <article class="prose prose-red prose-lg max-w-none">
                        {{ content|safe }}
                    </article>
                    
                    <div class="mt-8 pt-8 border-t border-gray-100">
                        <a href="{{ path_for('category_page', category=category) }}" class="text-primary hover:text-secondary font-medium flex items-center">
                            <svg class="w-4 h-4 ml-1 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            بازگشت به {{ category }}
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Sidebar (Left side on RTL) -->
        <div class="lg:w-1/4">
            <div class="sticky top-24">
                <div class="bg-white/50 backdrop-blur-sm rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 border-r-4 border-primary pr-3">
                        فهرست مطالب
                    </h3>
                    <div class="toc-container prose prose-sm prose-red max-w-none">
                        {{ toc|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

<div id="live-notes" class="fixed bottom-0 left-0 right-0 z-50 hidden transition-all duration-300 pointer-events-none">
    <div class="w-full pointer-events-auto">
        <div id="live-notes-inner" class="bg-white/95 backdrop-blur shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.2)] ring-1 ring-black/5 flex flex-col">
            <div class="px-6 py-3 bg-gray-50/80 border-b border-gray-100 flex items-center justify-between shrink-0">
                <div class="max-w-7xl mx-auto w-full flex items-center justify-between">
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <div class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></div>
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">یادداشت‌های این بخش</div>
                    </div>
                    <button id="toggle-notes" class="p-1.5 hover:bg-gray-200 rounded-xl transition-colors">
                        <svg id="toggle-icon" class="w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="live-notes-content-container" class="overflow-y-auto transition-all duration-300 ease-in-out">
                <div class="max-w-7xl mx-auto w-full px-6">
                    <div id="live-notes-content" class="py-5 space-y-5"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const article = document.querySelector('article.prose');
    if (!article) return;
    const notesContainer = document.getElementById('live-notes');
    const notesPanel = document.getElementById('live-notes-inner');
    const notesContent = document.getElementById('live-notes-content');
    const notesScrollContainer = document.getElementById('live-notes-content-container');
    const toggleBtn = document.getElementById('toggle-notes');
    const toggleIcon = document.getElementById('toggle-icon');
    
    let isCollapsed = false;
    toggleBtn.addEventListener('click', function() {
        isCollapsed = !isCollapsed;
        if (isCollapsed) {
            notesScrollContainer.style.maxHeight = '0';
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            notesScrollContainer.style.maxHeight = '250px'; // Set a reasonable default for bottom center
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    });

    function getText(el) {
        const clone = el.cloneNode(true);
        const backrefs = clone.querySelectorAll('a[href^="#fnref"], a.footnote-backref');
        backrefs.forEach(b => b.remove());
        return clone.innerHTML.trim();
    }

    const footnoteItems = {};
    const footnotesBlock = article.querySelector('.footnotes, .footnote');
    if (footnotesBlock) {
        const items = footnotesBlock.querySelectorAll('li[id]');
        items.forEach(li => {
            footnoteItems[li.id] = getText(li);
        });
    }

    const citationItems = {};
    const refsBlock = article.querySelector('#references, .references');
    if (refsBlock) {
        const items = refsBlock.querySelectorAll('[id]');
        items.forEach(el => {
            citationItems[el.id] = getText(el);
        });
    }

    const observed = [];
    const elToId = new Map();
    article.querySelectorAll('sup a[href^="#fn"]').forEach(a => {
        const sup = a.closest('sup') || a;
        const id = (a.getAttribute('href') || '').replace(/^#/, '');
        if (id) {
            observed.push(sup);
            elToId.set(sup, id);
        }
    });
    article.querySelectorAll('a[href^="#cite"]').forEach(a => {
        const id = (a.getAttribute('href') || '').replace(/^#/, '');
        if (id) {
            observed.push(a);
            elToId.set(a, id);
        }
    });

    const visibleSet = new Set();
    const observer = new IntersectionObserver(entries => {
        let changed = false;
        entries.forEach(e => {
            const targetId = elToId.get(e.target);
            if (!targetId) return;
            if (e.isIntersecting) {
                visibleSet.add(targetId);
            } else {
                visibleSet.delete(targetId);
            }
            changed = true;
        });
        if (changed) renderNotes();
    }, { root: null, threshold: 0, rootMargin: '0px 0px -33% 0px' });

    observed.forEach(el => observer.observe(el));

    function renderNotes() {
        const items = [];
        Array.from(visibleSet).forEach(id => {
            if (footnoteItems[id]) {
                const num = id.replace(/^\D+/, '');
                items.push({ type: 'footnote', id, num, html: footnoteItems[id] });
            } else if (citationItems[id]) {
                const num = id.replace(/^\D+/, '');
                items.push({ type: 'citation', id, num, html: citationItems[id] });
            }
        });
        
        items.sort((a,b) => {
            const numA = parseInt(a.num.replace(/\D/g, '')) || 0;
            const numB = parseInt(b.num.replace(/\D/g, '')) || 0;
            return numA - numB;
        });

        if (!items.length) {
            notesContainer.classList.add('hidden');
            return;
        }
        
        notesContainer.classList.remove('hidden');
        notesContent.innerHTML = '';
        
        items.forEach(item => {
            const wrap = document.createElement('div');
            wrap.className = 'text-sm text-gray-800 border-b border-gray-100 last:border-0 pb-4 last:pb-0';
            const label = item.type === 'footnote' ? 'یادداشت' : 'ارجاع';
            wrap.innerHTML = `<div class="font-bold text-primary mb-1 text-xs uppercase tracking-tight">${label} ${item.num}</div><div class="prose prose-sm max-w-none text-gray-600 leading-relaxed">${item.html}</div>`;
            notesContent.appendChild(wrap);
        });

        if (!isCollapsed) {
            notesScrollContainer.style.maxHeight = '250px';
        }
    }

    renderNotes();
});
    // Scroll Spy for TOC
    const tocLinks = Array.from(document.querySelectorAll('.toc-list a')).filter(link => link.textContent.trim() !== '');
    const headers = Array.from(document.querySelectorAll('article h1, article h2, article h3, article h4, article h5, article h6'))
        .filter(header => header.id && header.textContent.trim() !== '');

    // Hide empty TOC links from DOM if they exist
    document.querySelectorAll('.toc-list a').forEach(link => {
        if (link.textContent.trim() === '') {
            const li = link.closest('li');
            if (li) li.remove();
        }
    });

    function updateActiveToc() {
        let currentHeaderId = '';
        const scrollPosition = window.scrollY + 100; // Offset for navbar

        for (const header of headers) {
            if (header.offsetTop <= scrollPosition) {
                currentHeaderId = header.id;
            } else {
                break;
            }
        }

        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${currentHeaderId}`) {
                link.classList.add('active');
            }
        });
    }

    window.addEventListener('scroll', updateActiveToc);
    updateActiveToc();
</script>
{% endblock %}
